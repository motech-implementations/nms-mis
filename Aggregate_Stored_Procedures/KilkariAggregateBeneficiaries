CREATE DEFINER=`etluser`@`%` PROCEDURE `KilkariAggregateBeneficiaries`()
BEGIN
DECLARE dt DATETIME;
DECLARE i INT;
SET dt = (select cast(last_etl_time as datetime) from KilkariAgg.ETL_info_table where table_id = 48);
SET i = 1;
WHILE i<2 DO
SET i=i+1;
truncate table KilkariAgg.agg_aggregate_beneficiaries_temp;

insert into KilkariAgg.agg_aggregate_beneficiaries_temp(state_id, district_id, block_id, subcentre_id, date,self_deactivated, no_answer_deactivation, low_listener_deactivation, system_deactivation, mother_completed,child_completed,joined_subscription)

select b.state_id,b.district_id, b.healthBlock_id, b.healthSubFacility_id,dt as date,
count(distinct case when s.subscription_status = 'DEACTIVATED' and s.deactivation_reason = 'DEACTIVATED_BY_USER' and s.enddate between dt and DATE_ADD(dt, INTERVAL 1 MONTH) then b.id end) as self_deactivated,
count(distinct case when s.subscription_status = 'DEACTIVATED' and s.deactivation_reason = 'WEEKLY_CALLS_NOT_ANSWERED' and s.enddate between dt and DATE_ADD(dt, INTERVAL 1 MONTH) then b.id end) as no_answer_deactivation,
count(distinct case when s.subscription_status = 'DEACTIVATED' and s.deactivation_reason = 'LOW_LISTENERSHIP' and s.enddate between dt and DATE_ADD(dt, INTERVAL 1 MONTH) then b.id end) as low_listener_deactivation,
count(distinct case when s.subscription_status = 'DEACTIVATED' and s.deactivation_reason in ('MISCARRIAGE_OR_ABORTION', 'MCTS_UPDATE', 'LIVE_BIRTH', 'STILL_BIRTH', 'CHILD_DEATH', 'MATERNAL_DEATH') and s.enddate between dt and DATE_ADD(dt, INTERVAL 1 MONTH) then b.id end) as system_deactivation,
count(distinct case when s.subscriptionPack_id = 1 and s.subscription_status = 'COMPLETED' and s.enddate between dt and DATE_ADD(dt, INTERVAL 1 MONTH) then b.id end) as mother_completed,
count(distinct case when s.subscriptionPack_id = 2 and s.subscription_status = 'COMPLETED' and s.enddate between dt and DATE_ADD(dt, INTERVAL 1 MONTH) then b.id end) as child_completed,
count(distinct case when s.creation_time between dt and DATE_ADD(dt, INTERVAL 1 MONTH) then b.id end) as joined_subscription
from KilkariAgg.beneficiary_tracker b join KilkariAgg.subscriptions s where s.beneficiaryTracking_id = b.id 
group by b.state_id,b.district_id, b.healthBlock_id, b.healthSubFacility_id;


insert into KilkariAgg.agg_aggregate_beneficiaries (location_type, location_id, date, self_deactivated, no_answer_deactivation, low_listener_deactivation, system_deactivation, mother_completed,child_completed,joined_subscription)

select 'STATE' as location_type, state_id as location_id, date as date, sum(self_deactivated), sum(no_answer_deactivation), sum(low_listener_deactivation), sum(system_deactivation), sum(mother_completed),sum(child_completed),sum(joined_subscription) from KilkariAgg.agg_aggregate_beneficiaries_temp group by state_id

UNION ALL
select 'DISTRICT' as location_type, district_id as location_id, date as date, sum(self_deactivated), sum(no_answer_deactivation), sum(low_listener_deactivation), sum(system_deactivation), sum(mother_completed),sum(child_completed),sum(joined_subscription) from KilkariAgg.agg_aggregate_beneficiaries_temp group by district_id

UNION ALL
select 'BLOCK' as location_type, block_id as location_id, date as date, sum(self_deactivated), sum(no_answer_deactivation), sum(low_listener_deactivation), sum(system_deactivation), sum(mother_completed),sum(child_completed),sum(joined_subscription) from KilkariAgg.agg_aggregate_beneficiaries_temp group by block_id

UNION ALL
select 'SUBCENTRE' as location_type, subcentre_id as location_id, date as date, sum(self_deactivated), sum(no_answer_deactivation), sum(low_listener_deactivation), sum(system_deactivation), sum(mother_completed),sum(child_completed),sum(joined_subscription) from KilkariAgg.agg_aggregate_beneficiaries_temp group by subcentre_id;


SET dt = DATE_ADD(dt, INTERVAL 1 MONTH);
update KilkariAgg.ETL_info_table set last_etl_time = dt where table_id = 48;

END WHILE;

END
